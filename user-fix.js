// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –Ω–∞—á–∞–ª–æ app.js –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª user-fix.js

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VK Bridge
function initVKBridge() {
    let bridge = null;

    // –ù–∞—Ö–æ–¥–∏–º VK Bridge
    if (typeof vkBridge !== 'undefined') {
        bridge = vkBridge;
    } else if (typeof window.vkBridge !== 'undefined') {
        bridge = window.vkBridge;
    } else {
        console.warn('VK Bridge –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –≥–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º.');
        showGuestMode();
        return null;
    }

    try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º VK Bridge
        bridge.send('VKWebAppInit')
            .then(() => {
                console.log('VK Bridge —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                window.vkBridgeInstance = bridge;
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve(bridge.send('VKWebAppGetUserInfo'));
                    }, 500);
                });
            })
            .then((userData) => {
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã:', userData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                if (userData && userData.id && userData.first_name) {
                    currentUserData = userData;
                    updateUserInfo(userData);
                } else {
                    console.warn('–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);
                    showGuestMode();
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                return bridge.send('VKWebAppGetConfig');
            })
            .then((config) => {
                console.log('–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', config);
                if (config && config.scheme) {
                    applyVKTheme(config.scheme);
                }
            })
            .catch((error) => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å VK Bridge:', error);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                if (error.error_data && error.error_data.error_code === 3) {
                    console.log('–ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ...');
                    setTimeout(() => {
                        retryGetUserInfo(bridge);
                    }, 1000);
                } else {
                    showGuestMode();
                }
            });

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        bridge.subscribe((event) => {
            if (event.detail && event.detail.type === 'VKWebAppUpdateConfig') {
                applyVKTheme(event.detail.data.scheme);
            }
        });

        return bridge;
    } catch (e) {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å VK Bridge:', e);
        showGuestMode();
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function retryGetUserInfo(bridge, attempts = 0) {
    if (attempts >= 3) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫');
        showGuestMode();
        return;
    }
    
    bridge.send('VKWebAppGetUserInfo')
        .then((userData) => {
            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ:', userData);
            
            if (userData && userData.id && userData.first_name) {
                currentUserData = userData;
                updateUserInfo(userData);
            } else {
                console.warn('–ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ø—ã—Ç–∫–∞', attempts + 1);
                setTimeout(() => {
                    retryGetUserInfo(bridge, attempts + 1);
                }, 1000);
            }
        })
        .catch((error) => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
            setTimeout(() => {
                retryGetUserInfo(bridge, attempts + 1);
            }, 1000);
        });
}

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
function updateUserInfo(userData) {
    const userInfoElement = document.getElementById('user-info');
    const userInfoQuizElement = document.getElementById('user-info-quiz');
    
    if (!userData || !userData.first_name) {
        console.warn('–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞');
        return;
    }
    
    const userHTML = `
        <img src="${userData.photo_100 || 'https://vk.com/images/camera_100.png'}" 
             alt="${userData.first_name}" 
             onerror="this.src='https://vk.com/images/camera_100.png'">
        <span>${userData.first_name} ${userData.last_name || ''}</span>
    `;
    
    if (userInfoElement) {
        userInfoElement.innerHTML = userHTML;
        userInfoElement.style.display = 'flex';
    }
    
    if (userInfoQuizElement) {
        userInfoQuizElement.innerHTML = userHTML;
        userInfoQuizElement.style.display = 'flex';
    }
    
    console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ');
}

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
function showGuestMode() {
    const userInfoElement = document.getElementById('user-info');
    if (!userInfoElement) return;

    // –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è
    currentUserData = {
        id: 'guest_' + Date.now(),
        first_name: '–ì–æ—Å—Ç—å',
        last_name: '',
        photo_100: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiM1YTY3ZDgiLz4KPHN2ZyB4PSIyNSIgeT0iMjUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzEzLjEgMiAxNCAyLjkgMTQgNEMxNCA1LjEgMTMuMSA2IDEyIDZDMTAuOSA2IDEwIDUuMSAxMCA0QzEwIDIuOSAxMC45IDIgMTIgMlpNMjEgOVYyMkgxNVYxM0g5VjIySDNWOUgxWlY3SDIzVjlIMjFaIi8+Cjwvc3ZnPgo8L3N2Zz4K'
    };

    updateUserInfo(currentUserData);
    
    console.log('–ó–∞–ø—É—â–µ–Ω –≥–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º —Å ID:', currentUserData.id);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function forceUpdateUserInfo() {
    const bridge = window.vkBridgeInstance || window.vkBridge;
    
    if (!bridge) {
        console.warn('VK Bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        showGuestMode();
        return;
    }
    
    console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
    
    bridge.send('VKWebAppGetUserInfo')
        .then((userData) => {
            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', userData);
            if (userData && userData.id && userData.first_name) {
                currentUserData = userData;
                updateUserInfo(userData);
            } else {
                showGuestMode();
            }
        })
        .catch((error) => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
            showGuestMode();
        });
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.debugUser = {
    getCurrentUser: () => {
        console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUserData);
        return currentUserData;
    },
    
    forceUpdate: () => {
        forceUpdateUserInfo();
    },
    
    showGuest: () => {
        showGuestMode();
    },
    
    checkVK: () => {
        const bridge = window.vkBridgeInstance || window.vkBridge;
        console.log('VK Bridge –¥–æ—Å—Ç—É–ø–µ–Ω:', !!bridge);
        if (bridge) {
            console.log('–¢–∏–ø VK Bridge:', typeof bridge);
        }
        return !!bridge;
    }
};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (!currentUserData || currentUserData.first_name === '–ì–æ—Å—Ç—å') {
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            forceUpdateUserInfo();
        }
    }, 3000);
});

console.log('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
