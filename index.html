<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4a76a8">
    <title>Анатомический квиз</title>
    
    <!-- Стили -->
    <link rel="stylesheet" href="style.css">
    
    <!-- VK Bridge должен загружаться первым -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge@2.10.0/dist/browser.min.js"></script>
    
    <!-- Исправляем обработку вопросов для правильной работы со сложными вопросами -->
    <script>
        // Оригинальные функции проверки ответов будут перехвачены
        document.addEventListener('DOMContentLoaded', function() {
            // Сохраняем ссылку на оригинальную функцию nextButton.addEventListener из app.js
            const originalNextButtonClick = Element.prototype.addEventListener;
            
            // Переопределяем функцию addEventListener
            Element.prototype.addEventListener = function(event, callback, options) {
                if (this.id === 'next-question' && event === 'click') {
                    // Переопределяем callback для кнопки "Далее"
                    const enhancedCallback = function() {
                        if (window.selectedOption === null || !Array.isArray(window.questionsForQuiz) || 
                            window.currentQuestion >= window.questionsForQuiz.length) {
                            return;
                        }
                        
                        // Блокировка кнопки после клика
                        this.disabled = true;
                        
                        // Получаем текущий вопрос
                        const currentQuestionObj = window.questionsForQuiz[window.currentQuestion];
                        
                        // Проверка ответа - поддерживаем оба формата: correct и answer
                        let correctAnswerIndex;
                        if (currentQuestionObj.hasOwnProperty('correct')) {
                            correctAnswerIndex = currentQuestionObj.correct;
                        } else if (currentQuestionObj.hasOwnProperty('correctAnswer')) {
                            correctAnswerIndex = currentQuestionObj.correctAnswer;
                        } else if (currentQuestionObj.hasOwnProperty('answer')) {
                            correctAnswerIndex = currentQuestionObj.answer;
                        } else {
                            console.error('Не найден правильный ответ в вопросе:', currentQuestionObj);
                            correctAnswerIndex = 0; // По умолчанию
                        }
                        
                        // Если правильный ответ совпадает с выбранным, увеличиваем счет
                        if (window.selectedOption === correctAnswerIndex) {
                            window.score++;
                        }
                        
                        // Подсветка правильного/неправильного ответа
                        const options = document.querySelectorAll('.option');
                        if (options[correctAnswerIndex]) options[correctAnswerIndex].classList.add('correct');
                        if (window.selectedOption !== correctAnswerIndex && options[window.selectedOption]) {
                            options[window.selectedOption].classList.add('wrong');
                        }
                        
                        // Блокировка выбора после проверки
                        options.forEach(option => {
                            if (typeof window.selectOption === 'function') {
                                option.removeEventListener('click', window.selectOption);
                            }
                            option.style.pointerEvents = 'none';
                        });
                        
                        // Задержка перед следующим вопросом
                        setTimeout(() => {
                            window.currentQuestion++;
                            
                            if (window.currentQuestion < window.questionsForQuiz.length) {
                                if (typeof window.loadQuestion === 'function') {
                                    window.loadQuestion();
                                }
                            } else {
                                if (typeof window.showResults === 'function') {
                                    window.showResults();
                                }
                            }
                        }, 1500);  // 1.5 секунды, чтобы увидеть правильный ответ
                    };
                    
                    return originalNextButtonClick.call(this, event, enhancedCallback, options);
                }
                
                // Для всех остальных случаев используем оригинальную функцию
                return originalNextButtonClick.call(this, event, callback, options);
            };
        });
    </script>
    
    <!-- Загрузка сложных вопросов из JSON и их нормализация -->
    <script>
        // Загрузка сложных вопросов при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Глобальные переменные для хранения оригинальных и сложных вопросов
            window.originalQuestions = [];
            window.difficultQuestions = [];
            
            // Сохраняем оригинальные вопросы, если они доступны
            if (window.questions && Array.isArray(window.questions)) {
                window.originalQuestions = [...window.questions];
                console.log('Сохранены оригинальные вопросы:', window.originalQuestions.length);
            }
            
            // Загружаем сложные вопросы
            fetch('difficult-questions.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        throw new Error('Загруженные данные не являются массивом или пусты');
                    }
                    
                    // Нормализуем формат сложных вопросов
                    window.difficultQuestions = data.map(question => {
                        // Создаем копию вопроса
                        const normalizedQuestion = {...question};
                        
                        // Если в вопросе есть поле answer, копируем его в correct и correctAnswer
                        if (normalizedQuestion.hasOwnProperty('answer') && !normalizedQuestion.hasOwnProperty('correct')) {
                            normalizedQuestion.correct = normalizedQuestion.answer;
                        }
                        
                        if (normalizedQuestion.hasOwnProperty('answer') && !normalizedQuestion.hasOwnProperty('correctAnswer')) {
                            normalizedQuestion.correctAnswer = normalizedQuestion.answer;
                        }
                        
                        return normalizedQuestion;
                    });
                    
                    console.log(`Загружено и нормализовано ${window.difficultQuestions.length} сложных вопросов`);
                    
                    // Назначаем обработчики для кнопок выбора сложности
                    setupDifficultyButtons();
                    
                    // Создаем событие о загрузке сложных вопросов
                    const event = new CustomEvent('difficultQuestionsLoaded', { 
                        detail: { count: window.difficultQuestions.length } 
                    });
                    document.dispatchEvent(event);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке сложных вопросов:', error);
                });
        });
        
        // Функция для настройки кнопок выбора сложности
        function setupDifficultyButtons() {
            const normalButton = document.getElementById('normal-difficulty');
            const hardButton = document.getElementById('hard-difficulty');
            
            if (!normalButton || !hardButton) {
                console.warn('Кнопки выбора сложности не найдены');
                return;
            }
            
            // Обработчик для обычных вопросов
            normalButton.addEventListener('click', function() {
                if (window.originalQuestions.length > 0) {
                    window.questions = window.originalQuestions;
                    console.log('Установлен набор обычных вопросов:', window.questions.length);
                    
                    // Визуальное выделение
                    normalButton.classList.add('active');
                    hardButton.classList.remove('active');
                }
            });
            
            // Обработчик для сложных вопросов
            hardButton.addEventListener('click', function() {
                if (window.difficultQuestions.length > 0) {
                    window.questions = window.difficultQuestions;
                    console.log('Установлен набор сложных вопросов:', window.questions.length);
                    
                    // Визуальное выделение
                    hardButton.classList.add('active');
                    normalButton.classList.remove('active');
                }
            });
        }
    </script>
    
    <!-- Анимационные файлы и звуки -->
    <script src="animations.js"></script>
    <script src="animated-background.js"></script>
    <script src="animated-pulse-line.js"></script>
    <script src="sound-effects.js"></script>
    <script src="enhanced-results.js"></script>
    <script src="enhanced-sharing.js"></script>
    
    <!-- Основные скрипты -->
    <script src="vk-difficulty.js"></script>
    <script src="app.js" defer></script>
</head>
<body>
    <!-- Анимированный фон -->
    <div id="animated-background" class="anatomy-background-wrapper"></div>
    
    <!-- Стартовый экран -->
    <div id="start-screen">
        <h1>Анатомический квиз</h1>
        <p>Проверьте свои знания анатомии человека!</p>
        
        <!-- Информация о пользователе -->
        <div id="user-info"></div>
        
        <!-- Анимированная линия пульса добавляется через JavaScript -->
        
        <!-- Селектор сложности -->
        <div class="difficulty-selector">
            <h3>Выберите уровень сложности:</h3>
            <div class="difficulty-buttons">
                <button id="normal-difficulty" class="difficulty-btn active">Обычный</button>
                <button id="hard-difficulty" class="difficulty-btn">Сложный</button>
            </div>
        </div>
        
        <!-- Кнопка старта -->
        <button id="start-quiz" class="btn-start">Начать тест</button>
    </div>
    
    <!-- Контейнер с вопросами -->
    <div id="quiz-container" style="display: none;">
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        
        <div id="question-counter">Вопрос 1 из 25</div>
        
        <div id="question"></div>
        
        <div id="options"></div>
        
        <button id="next-question" disabled>Далее</button>
    </div>
    
    <!-- Экран результатов -->
    <div id="results-container" style="display: none;">
        <h2>Ваш результат</h2>
        
        <div id="score"></div>
        
        <div class="result-buttons">
            <button id="share-results">Поделиться</button>
            <button id="restart-quiz">Пройти еще раз</button>
        </div>
    </div>
    
    <!-- Контейнер для звуковых эффектов -->
    <div id="sound-container" style="display: none;"></div>
    
    <!-- Контейнер для анимаций счета -->
    <div id="animations-container"></div>
</body>
</html>
