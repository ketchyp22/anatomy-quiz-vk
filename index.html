<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4a76a8">
    <title>Анатомический квиз</title>
    
    <!-- Стили -->
    <link rel="stylesheet" href="style.css">
    
    <!-- VK Bridge должен загружаться первым -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge@2.10.0/dist/browser.min.js"></script>
    
    <!-- Основные вопросы -->
    <script src="questions.js"></script>
    
    <!-- Исправление ошибки VK Bridge -->
    <script>
        // Переопределяем ensureVKBridge, чтобы он всегда возвращал Promise
        window.originalEnsureVKBridge = window.ensureVKBridge;
        window.ensureVKBridge = function() {
            const result = window.originalEnsureVKBridge ? window.originalEnsureVKBridge() : null;
            
            if (result && typeof result.then === 'function') {
                // Если result уже Promise, просто возвращаем его
                return result;
            } else {
                // Иначе создаем Promise, который разрешается с найденным VK Bridge или null
                return new Promise((resolve) => {
                    if (typeof vkBridge !== 'undefined') {
                        resolve(vkBridge);
                    } else if (typeof window.vkBridge !== 'undefined') {
                        resolve(window.vkBridge);
                    } else {
                        resolve(null);
                    }
                });
            }
        };
    </script>
    
    <!-- Загрузка сложных вопросов из JSON и их нормализация -->
    <script>
        // Загрузка сложных вопросов при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Начинаем загрузку сложных вопросов");
            
            // Глобальные переменные для хранения вопросов
            window.originalQuestions = [];
            window.difficultQuestions = [];
            
            // Таймер для проверки доступности оригинальных вопросов
            const checkQuestionsInterval = setInterval(function() {
                if (window.questions && Array.isArray(window.questions)) {
                    clearInterval(checkQuestionsInterval);
                    console.log("Найдены оригинальные вопросы, можно продолжать");
                    
                    // Сохраняем оригинальные вопросы
                    window.originalQuestions = [...window.questions];
                    console.log('Сохранены оригинальные вопросы:', window.originalQuestions.length);
                    
                    // Загружаем сложные вопросы
                    loadDifficultQuestions();
                }
            }, 100);
            
            // Прекращаем проверку через 5 секунд, если вопросы так и не загрузились
            setTimeout(function() {
                clearInterval(checkQuestionsInterval);
                if (!window.originalQuestions.length) {
                    console.warn("Не удалось дождаться загрузки оригинальных вопросов");
                    loadDifficultQuestions();
                }
            }, 5000);
            
            // Функция загрузки сложных вопросов
            function loadDifficultQuestions() {
                console.log("Загрузка сложных вопросов из JSON");
                
                fetch('difficult-questions.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data) || data.length === 0) {
                            throw new Error('Загруженные данные не являются массивом или пусты');
                        }
                        
                        console.log("Получено", data.length, "сложных вопросов");
                        
                        // Нормализуем формат сложных вопросов
                        window.difficultQuestions = data.map(question => {
                            // Создаем копию вопроса
                            const normalizedQuestion = {...question};
                            
                            // Если в вопросе есть поле answer, копируем его в correct
                            if (normalizedQuestion.hasOwnProperty('answer')) {
                                normalizedQuestion.correct = normalizedQuestion.answer;
                                normalizedQuestion.correctAnswer = normalizedQuestion.answer;
                            }
                            
                            return normalizedQuestion;
                        });
                        
                        console.log(`Загружено и нормализовано ${window.difficultQuestions.length} сложных вопросов`);
                        
                        // Переопределяем обработчик кнопки "Далее"
                        overrideNextButtonHandler();
                        
                        // Назначаем обработчики для кнопок выбора сложности
                        setupDifficultyButtons();
                        
                        // Создаем событие о загрузке сложных вопросов
                        const event = new CustomEvent('difficultQuestionsLoaded', { 
                            detail: { count: window.difficultQuestions.length } 
                        });
                        document.dispatchEvent(event);
                    })
                    .catch(error => {
                        console.error('Ошибка при загрузке сложных вопросов:', error);
                    });
            }
            
            // Функция переопределения обработчика кнопки "Далее"
            function overrideNextButtonHandler() {
                const nextButton = document.getElementById('next-question');
                if (!nextButton) {
                    console.warn("Кнопка 'Далее' не найдена, ждем её появления");
                    setTimeout(overrideNextButtonHandler, 500);
                    return;
                }
                
                // Удаляем все существующие обработчики
                const newButton = nextButton.cloneNode(true);
                nextButton.parentNode.replaceChild(newButton, nextButton);
                
                // Добавляем новый обработчик
                newButton.addEventListener('click', function() {
                    if (window.selectedOption === null || !Array.isArray(window.questionsForQuiz) || 
                        window.currentQuestion >= window.questionsForQuiz.length) {
                        return;
                    }
                    
                    // Блокировка кнопки после клика
                    this.disabled = true;
                    
                    // Получаем текущий вопрос
                    const currentQuestionObj = window.questionsForQuiz[window.currentQuestion];
                    
                    // Проверка ответа - поддерживаем оба формата: correct и answer
                    let correctAnswerIndex;
                    if (currentQuestionObj.hasOwnProperty('correct')) {
                        correctAnswerIndex = currentQuestionObj.correct;
                    } else if (currentQuestionObj.hasOwnProperty('correctAnswer')) {
                        correctAnswerIndex = currentQuestionObj.correctAnswer;
                    } else if (currentQuestionObj.hasOwnProperty('answer')) {
                        correctAnswerIndex = currentQuestionObj.answer;
                    } else {
                        console.error('Не найден правильный ответ в вопросе:', currentQuestionObj);
                        correctAnswerIndex = 0; // По умолчанию
                    }
                    
                    // Если правильный ответ совпадает с выбранным, увеличиваем счет
                    if (window.selectedOption === correctAnswerIndex) {
                        window.score++;
                    }
                    
                    // Подсветка правильного/неправильного ответа
                    const options = document.querySelectorAll('.option');
                    if (options[correctAnswerIndex]) options[correctAnswerIndex].classList.add('correct');
                    if (window.selectedOption !== correctAnswerIndex && options[window.selectedOption]) {
                        options[window.selectedOption].classList.add('wrong');
                    }
                    
                    // Блокировка выбора после проверки
                    options.forEach(option => {
                        option.style.pointerEvents = 'none';
                    });
                    
                    // Задержка перед следующим вопросом
                    setTimeout(() => {
                        window.currentQuestion++;
                        
                        if (window.currentQuestion < window.questionsForQuiz.length) {
                            if (typeof window.loadQuestion === 'function') {
                                window.loadQuestion();
                            }
                        } else {
                            if (typeof window.showResults === 'function') {
                                window.showResults();
                            }
                        }
                    }, 1500);
                });
                
                console.log("Обработчик кнопки 'Далее' успешно переопределен");
            }
        });
        
        // Функция для настройки кнопок выбора сложности
        function setupDifficultyButtons() {
            const normalButton = document.getElementById('normal-difficulty');
            const hardButton = document.getElementById('hard-difficulty');
            
            if (!normalButton || !hardButton) {
                console.warn('Кнопки выбора сложности не найдены');
                return;
            }
            
            console.log("Настройка кнопок выбора сложности");
            
            // Обработчик для обычных вопросов
            normalButton.addEventListener('click', function() {
                if (window.originalQuestions && window.originalQuestions.length > 0) {
                    window.questions = window.originalQuestions;
                    console.log('Установлен набор обычных вопросов:', window.questions.length);
                    
                    // Визуальное выделение
                    normalButton.classList.add('active');
                    hardButton.classList.remove('active');
                } else {
                    console.warn("Оригинальные вопросы не найдены");
                }
            });
            
            // Обработчик для сложных вопросов
            hardButton.addEventListener('click', function() {
                if (window.difficultQuestions && window.difficultQuestions.length > 0) {
                    window.questions = window.difficultQuestions;
                    console.log('Установлен набор сложных вопросов:', window.questions.length);
                    
                    // Визуальное выделение
                    hardButton.classList.add('active');
                    normalButton.classList.remove('active');
                } else {
                    console.warn("Сложные вопросы не загружены");
                }
            });
            
            console.log("Кнопки выбора сложности настроены");
        }
    </script>
    
    <!-- Анимационные файлы и звуки -->
    <script src="animations.js"></script>
    <script src="animated-background.js"></script>
    <script src="animated-pulse-line.js"></script>
    <script src="sound-effects.js"></script>
    <script src="enhanced-results.js"></script>
    <script src="enhanced-sharing.js"></script>
    
    <!-- Основные скрипты -->
    <script src="vk-difficulty.js"></script>
    <script src="app.js" defer></script>
</head>
<body>
    <!-- Анимированный фон -->
    <div id="animated-background" class="anatomy-background-wrapper"></div>
    
    <!-- Стартовый экран -->
    <div id="start-screen">
        <h1>Анатомический квиз</h1>
        <p>Проверьте свои знания анатомии человека!</p>
        
        <!-- Информация о пользователе -->
        <div id="user-info"></div>
        
        <!-- Анимированная линия пульса добавляется через JavaScript -->
        
        <!-- Селектор сложности -->
        <div class="difficulty-selector">
            <h3>Выберите уровень сложности:</h3>
            <div class="difficulty-buttons">
                <button id="normal-difficulty" class="difficulty-btn active">Обычный</button>
                <button id="hard-difficulty" class="difficulty-btn">Сложный</button>
            </div>
        </div>
        
        <!-- Кнопка старта -->
        <button id="start-quiz" class="btn-start">Начать тест</button>
    </div>
    
    <!-- Контейнер с вопросами -->
    <div id="quiz-container" style="display: none;">
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        
        <div id="question-counter">Вопрос 1 из 25</div>
        
        <div id="question"></div>
        
        <div id="options"></div>
        
        <button id="next-question" disabled>Далее</button>
    </div>
    
    <!-- Экран результатов -->
    <div id="results-container" style="display: none;">
        <h2>Ваш результат</h2>
        
        <div id="score"></div>
        
        <div class="result-buttons">
            <button id="share-results">Поделиться</button>
            <button id="restart-quiz">Пройти еще раз</button>
        </div>
    </div>
    
    <!-- Контейнер для звуковых эффектов -->
    <div id="sound-container" style="display: none;"></div>
    
    <!-- Контейнер для анимаций счета -->
    <div id="animations-container"></div>
</body>
</html>
