<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4a76a8">
    <title>Анатомический квиз</title>
    
    <!-- Стили -->
    <link rel="stylesheet" href="style.css">
    
    <!-- VK Bridge должен загружаться первым -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge@2.10.0/dist/browser.min.js"></script>
    
    <!-- Основные вопросы -->
    <script src="questions.js"></script>
    
    <!-- Загрузка сложных вопросов из JSON и нормализация формата -->
    <script>
        // Загрузка сложных вопросов при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Глобальные переменные для хранения оригинальных и сложных вопросов
            window.originalQuestions = [];
            window.difficultQuestions = [];
            
            // Сохраняем оригинальные вопросы, если они доступны
            if (window.questions && Array.isArray(window.questions)) {
                window.originalQuestions = [...window.questions];
                console.log('Сохранены оригинальные вопросы:', window.originalQuestions.length);
            }
            
            // Загружаем сложные вопросы
            fetch('difficult-questions.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        throw new Error('Загруженные данные не являются массивом или пусты');
                    }
                    
                    // Нормализуем формат сложных вопросов
                    window.difficultQuestions = data.map(question => {
                        // Создаем копию вопроса
                        const normalizedQuestion = {...question};
                        
                        // Если в вопросе есть поле answer, но нет correctAnswer
                        if (normalizedQuestion.hasOwnProperty('answer') && !normalizedQuestion.hasOwnProperty('correctAnswer')) {
                            normalizedQuestion.correctAnswer = normalizedQuestion.answer;
                        }
                        
                        return normalizedQuestion;
                    });
                    
                    console.log(`Загружено и нормализовано ${window.difficultQuestions.length} сложных вопросов`);
                    
                    // Назначаем обработчики для кнопок выбора сложности
                    setupDifficultyButtons();
                    
                    // Создаем событие о загрузке сложных вопросов
                    const event = new CustomEvent('difficultQuestionsLoaded', { 
                        detail: { count: window.difficultQuestions.length } 
                    });
                    document.dispatchEvent(event);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке сложных вопросов:', error);
                });
        });
        
        // Функция для настройки кнопок выбора сложности
        function setupDifficultyButtons() {
            const normalButton = document.getElementById('normal-difficulty');
            const hardButton = document.getElementById('hard-difficulty');
            
            if (!normalButton || !hardButton) {
                console.warn('Кнопки выбора сложности не найдены');
                return;
            }
            
            // Обработчик для обычных вопросов
            normalButton.addEventListener('click', function() {
                if (window.originalQuestions.length > 0) {
                    window.questions = window.originalQuestions;
                    console.log('Установлен набор обычных вопросов:', window.questions.length);
                    
                    // Визуальное выделение
                    normalButton.classList.add('active');
                    hardButton.classList.remove('active');
                }
            });
            
            // Обработчик для сложных вопросов
            hardButton.addEventListener('click', function() {
                if (window.difficultQuestions.length > 0) {
                    window.questions = window.difficultQuestions;
                    console.log('Установлен набор сложных вопросов:', window.questions.length);
                    
                    // Визуальное выделение
                    hardButton.classList.add('active');
                    normalButton.classList.remove('active');
                }
            });
        }
    </script>
    
    <!-- Анимационные файлы и звуки -->
    <script src="animations.js"></script>
    <script src="animated-background.js"></script>
    <script src="animated-pulse-line.js"></script>
    <script src="sound-effects.js"></script>
    <script src="enhanced-results.js"></script>
    <script src="enhanced-sharing.js"></script>
    
    <!-- Основные скрипты -->
    <script src="vk-difficulty.js"></script>
    <script src="app.js" defer></script>
</head>
<body>
    <!-- Анимированный фон -->
    <div id="animated-background" class="anatomy-background-wrapper"></div>
    
    <!-- Стартовый экран -->
    <div id="start-screen">
        <h1>Анатомический квиз</h1>
        <p>Проверьте свои знания анатомии человека!</p>
        
        <!-- Информация о пользователе -->
        <div id="user-info"></div>
        
        <!-- Анимированная линия пульса добавляется через JavaScript -->
        
        <!-- Селектор сложности -->
        <div class="difficulty-selector">
            <h3>Выберите уровень сложности:</h3>
            <div class="difficulty-buttons">
                <button id="normal-difficulty" class="difficulty-btn active">Обычный</button>
                <button id="hard-difficulty" class="difficulty-btn">Сложный</button>
            </div>
        </div>
        
        <!-- Кнопка старта -->
        <button id="start-quiz" class="btn-start">Начать тест</button>
    </div>
    
    <!-- Контейнер с вопросами -->
    <div id="quiz-container" style="display: none;">
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        
        <div id="question-counter">Вопрос 1 из 25</div>
        
        <div id="question"></div>
        
        <div id="options"></div>
        
        <button id="next-question" disabled>Далее</button>
    </div>
    
    <!-- Экран результатов -->
    <div id="results-container" style="display: none;">
        <h2>Ваш результат</h2>
        
        <div id="score"></div>
        
        <div class="result-buttons">
            <button id="share-results">Поделиться</button>
            <button id="restart-quiz">Пройти еще раз</button>
        </div>
    </div>
    
    <!-- Контейнер для звуковых эффектов -->
    <div id="sound-container" style="display: none;"></div>
    
    <!-- Контейнер для анимаций счета -->
    <div id="animations-container"></div>
</body>
</html>
